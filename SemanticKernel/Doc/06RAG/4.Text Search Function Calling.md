# Why use function calling with Semantic Kernel Text Search? 为什么要将函数调用与Semantic Kernel文本搜索一起使用？

- 10/16/2024

In the previous Retrieval-Augmented Generation (RAG) based samples the user ask has been used as the search query when retrieving relevant information. The user ask could be long and may span multiple topics or there may be multiple different search implementations available which provide specialized results. For either of these scenarios it can be useful to allow the AI model to extract the search query or queries from the user ask and use function calling to retrieve the relevant information it needs.
在之前基于检索增强生成 （RAG） 的示例中，在检索相关信息时，用户询问已用作搜索查询。用户提问可能很长，可能跨越多个主题，或者可能有多个不同的搜索实现可用，这些实现可以提供专门的结果。对于上述任一方案，允许 AI 模型从用户中提取一个或多个搜索查询，询问并使用函数调用来检索所需的相关信息，这都很有用。

 Tip  提示

To run the samples shown on this page go to [GettingStartedWithTextSearch/Step3_Search_With_FunctionCalling.cs](https://github.com/microsoft/semantic-kernel/blob/main/dotnet/samples/GettingStartedWithTextSearch/Step3_Search_With_FunctionCalling.cs).
若要运行此页上显示的示例，请转到 [GettingStartedWithTextSearch/Step3_Search_With_FunctionCalling.cs](https://github.com/microsoft/semantic-kernel/blob/main/dotnet/samples/GettingStartedWithTextSearch/Step3_Search_With_FunctionCalling.cs)。



## Function calling with Bing text search 使用必应文本搜索调用函数

 Tip  提示

The samples in this section use an `IFunctionInvocationFilter` filter to log the function that the model calls and what parameters it sends. It is interesting to see what the model uses as a search query when calling the `SearchPlugin`.
本部分中的示例使用 `IFunctionInvocationFilter` 筛选器来记录模型调用的函数及其发送的参数。有趣的是，在调用 `SearchPlugin` 时，模型使用什么作为搜索查询。

Here is the `IFunctionInvocationFilter` filter implementation.
下面是 `IFunctionInvocationFilter` 筛选器实现。

C#Copy  复制

```csharp
private sealed class FunctionInvocationFilter(TextWriter output) : IFunctionInvocationFilter
{
    public async Task OnFunctionInvocationAsync(FunctionInvocationContext context, Func<FunctionInvocationContext, Task> next)
    {
        if (context.Function.PluginName == "SearchPlugin")
        {
            output.WriteLine($"{context.Function.Name}:{JsonSerializer.Serialize(context.Arguments)}\n");
        }
        await next(context);
    }
}
```

The sample below creates a `SearchPlugin` using Bing web search. This plugin will be advertised to the AI model for use with automatic function calling, using the `FunctionChoiceBehavior` in the prompt execution settings. When you run this sample check the console output to see what the model used as the search query.
下面的示例使用必应 Web 搜索创建 `SearchPlugin`。此插件将使用提示执行设置中的 `FunctionChoiceBehavior` 通告给 AI 模型，以便用于自动函数调用。运行此示例时，请检查控制台输出，查看模型用作搜索查询的内容。

C#Copy  复制

```csharp
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Connectors.OpenAI;
using Microsoft.SemanticKernel.Data;
using Microsoft.SemanticKernel.Plugins.Web.Bing;

// Create a kernel with OpenAI chat completion
IKernelBuilder kernelBuilder = Kernel.CreateBuilder();
kernelBuilder.AddOpenAIChatCompletion(
        modelId: "gpt-4o",
        apiKey: "<Your OpenAI API Key>");
kernelBuilder.Services.AddSingleton<ITestOutputHelper>(output);
kernelBuilder.Services.AddSingleton<IFunctionInvocationFilter, FunctionInvocationFilter>();
Kernel kernel = kernelBuilder.Build();

// Create a search service with Bing search
var textSearch = new BingTextSearch(apiKey: "<Your Bing API Key>");

// Build a text search plugin with Bing search and add to the kernel
var searchPlugin = textSearch.CreateWithSearch("SearchPlugin");
kernel.Plugins.Add(searchPlugin);

// Invoke prompt and use text search plugin to provide grounding information
OpenAIPromptExecutionSettings settings = new() { FunctionChoiceBehavior = FunctionChoiceBehavior.Auto() };
KernelArguments arguments = new(settings);
Console.WriteLine(await kernel.InvokePromptAsync("What is the Semantic Kernel?", arguments));
```



## Function calling with Bing text search and citations 使用必应文本搜索和引文进行函数调用

The sample below includes the required changes to include citations:
以下示例包括包含引文所需的更改：

1. Use `CreateWithGetTextSearchResults` to create the `SearchPlugin`, this will include the link to the original source of the information.
   用于 `CreateWithGetTextSearchResults` 创建 `SearchPlugin`，这将包括指向信息原始源的链接。
2. Modify the prompt to instruct the model to include citations in it's response.
   修改提示以指示模型在其响应中包含引文。

C#Copy  复制

```csharp
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Connectors.OpenAI;
using Microsoft.SemanticKernel.Data;
using Microsoft.SemanticKernel.Plugins.Web.Bing;

// Create a kernel with OpenAI chat completion
IKernelBuilder kernelBuilder = Kernel.CreateBuilder();
kernelBuilder.AddOpenAIChatCompletion(
        modelId: "gpt-4o",
        apiKey: "<Your OpenAI API Key>");
kernelBuilder.Services.AddSingleton<ITestOutputHelper>(output);
kernelBuilder.Services.AddSingleton<IFunctionInvocationFilter, FunctionInvocationFilter>();
Kernel kernel = kernelBuilder.Build();

// Create a search service with Bing search
var textSearch = new BingTextSearch(apiKey: "<Your Bing API Key>");

// Build a text search plugin with Bing search and add to the kernel
var searchPlugin = textSearch.CreateWithGetTextSearchResults("SearchPlugin");
kernel.Plugins.Add(searchPlugin);

// Invoke prompt and use text search plugin to provide grounding information
OpenAIPromptExecutionSettings settings = new() { FunctionChoiceBehavior = FunctionChoiceBehavior.Auto() };
KernelArguments arguments = new(settings);
Console.WriteLine(await kernel.InvokePromptAsync("What is the Semantic Kernel? Include citations to the relevant information where it is referenced in the response.", arguments));
```



## Function calling with Bing text search and filtering 使用必应文本搜索和筛选进行函数调用

The final sample in this section shows how to use a filter with function calling. For this sample only search results from the Microsoft Developer Blogs site will be included. An instance of `TextSearchFilter` is created and an equality clause is added to match the `devblogs.microsoft.com` site. This filter will be used when the function is invoked in response to a function calling request from the model.
本部分中的最后一个示例演示如何将筛选器与函数调用一起使用。对于此示例，将仅包括来自 Microsoft 开发人员博客网站的搜索结果。将创建 `TextSearchFilter` 的实例，并添加相等子句以匹配 `devblogs.microsoft.com` 网站。当调用函数以响应来自模型的函数调用请求时，将使用此过滤器。

C#Copy  复制

```csharp
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Connectors.OpenAI;
using Microsoft.SemanticKernel.Data;
using Microsoft.SemanticKernel.Plugins.Web.Bing;

// Create a kernel with OpenAI chat completion
IKernelBuilder kernelBuilder = Kernel.CreateBuilder();
kernelBuilder.AddOpenAIChatCompletion(
        modelId: "gpt-4o",
        apiKey: "<Your OpenAI API Key>");
kernelBuilder.Services.AddSingleton<ITestOutputHelper>(output);
kernelBuilder.Services.AddSingleton<IFunctionInvocationFilter, FunctionInvocationFilter>();
Kernel kernel = kernelBuilder.Build();

// Create a search service with Bing search
var textSearch = new BingTextSearch(apiKey: "<Your Bing API Key>");

// Build a text search plugin with Bing search and add to the kernel
var filter = new TextSearchFilter().Equality("site", "devblogs.microsoft.com");
var searchOptions = new TextSearchOptions() { Filter = filter };
var searchPlugin = KernelPluginFactory.CreateFromFunctions(
    "SearchPlugin", "Search Microsoft Developer Blogs site only",
    [textSearch.CreateGetTextSearchResults(searchOptions: searchOptions)]);
kernel.Plugins.Add(searchPlugin);

// Invoke prompt and use text search plugin to provide grounding information
OpenAIPromptExecutionSettings settings = new() { FunctionChoiceBehavior = FunctionChoiceBehavior.Auto() };
KernelArguments arguments = new(settings);
Console.WriteLine(await kernel.InvokePromptAsync("What is the Semantic Kernel? Include citations to the relevant information where it is referenced in the response.", arguments));
```



## Next steps  后续步骤

[  使用矢量存储进行文本搜索](https://learn.microsoft.com/en-us/semantic-kernel/concepts/text-search/text-search-vector-stores)