# Magentic Orchestration  Magentic 编排

- 05/23/2025



 Important  重要

Agent Orchestration features in the Agent Framework are in the experimental stage. They are under active development and may change significantly before advancing to the preview or release candidate stage.
代理框架中的代理业务流程功能处于实验阶段。它们正在积极开发中，在进入预览版或候选版本阶段之前可能会发生重大变化。

Magentic orchestration is designed based on the [Magentic-One](https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/magentic-one.html) system invented by AutoGen. It is a flexible, general-purpose multi-agent pattern designed for complex, open-ended tasks that require dynamic collaboration. In this pattern, a dedicated Magentic manager coordinates a team of specialized agents, selecting which agent should act next based on the evolving context, task progress, and agent capabilities.
Magentic 编排是基于 AutoGen 发明的 [Magentic-One](https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/magentic-one.html) 系统设计的。它是一种灵活的通用多代理模式，专为需要动态协作的复杂、开放式任务而设计。在这种模式下，专门的 Magentic 经理协调一个专业代理团队，根据不断变化的上下文、任务进度和代理能力选择下一步应采取行动的代理。

The Magentic manager maintains a shared context, tracks progress, and adapts the workflow in real time. This enables the system to break down complex problems, delegate subtasks, and iteratively refine solutions through agent collaboration. The orchestration is especially well-suited for scenarios where the solution path is not known in advance and may require multiple rounds of reasoning, research, and computation.
Magentic 经理维护共享上下文、跟踪进度并实时调整工作流程。这使得系统能够分解复杂的问题、委派子任务并通过代理协作迭代完善解决方案。编排特别适用于事先不知道求解路径且可能需要多轮推理、研究和计算的场景。

 Tip  提示

Read more about the Magentic-One [here](https://www.microsoft.com/research/articles/magentic-one-a-generalist-multi-agent-system-for-solving-complex-tasks/).
在[此处](https://www.microsoft.com/research/articles/magentic-one-a-generalist-multi-agent-system-for-solving-complex-tasks/)阅读有关 Magentic-One 的更多信息。

 Tip  提示

The name "Magentic" comes from "Magentic-One". "Magentic-One" is a multi-agent system that includes a set of agents, such as the `WebSurfer` and `FileSurfer`. The Semantic Kernel Magentic orchestration is inspired by the Magentic-One system where the `Magentic` manager coordinates a team of specialized agents to solve complex tasks. However, it is not a direct implementation of the Magentic-One system and does not feature the agents from the Magentic-One system.
“Magentic”这个名字来源于“Magentic-One”。“Magentic-One”是一个多代理系统，包括一组代理，例如 `WebSurfer` 和 `FileSurfer`。语义内核 Magentic 编排的灵感来自 Magentic-One 系统，其中 `Magentic` 管理器协调一个专业代理团队来解决复杂的任务。但是，它不是 Magentic-One 系统的直接实现，也不具有 Magentic-One 系统中的代理。

To learn more about the pattern, such as when to use the pattern or when to avoid the pattern in your workload, see [Magentic orchestration](https://learn.microsoft.com/en-us/azure/architecture/ai-ml/guide/ai-agent-design-patterns#magentic-orchestration).
若要了解有关该模式的详细信息，例如何时使用该模式或何时避免工作负载中的该模式，请参阅 [Magentic 业务流程 ](https://learn.microsoft.com/en-us/azure/architecture/ai-ml/guide/ai-agent-design-patterns#magentic-orchestration)。



## Common Use Cases  常见用例

A user requests a comprehensive report comparing the energy efficiency and CO₂ emissions of different machine learning models. The Magentic manager first assigns a research agent to gather relevant data, then delegates analysis and computation to a coder agent. The manager coordinates multiple rounds of research and computation, aggregates the findings, and produces a detailed, structured report as the final output.
用户要求提供一份综合报告，比较不同机器学习模型的能源效率和二氧化碳排放量。Magentic 管理器首先分配一个研究代理来收集相关数据，然后将分析和计算委托给编码代理。经理协调多轮研究和计算，汇总调查结果，并生成详细的结构化报告作为最终输出。

![diagram](https://learn.microsoft.com/en-us/semantic-kernel/media/multi-agent-magentic.png)



## What You'll Learn  您将学到什么

- How to define and configure agents for Magentic orchestration
  如何定义和配置 Magentic 业务流程的代理
- How to set up a Magentic manager to coordinate agent collaboration
  如何设置 Magentic 管理器来协调代理协作
- How the orchestration process works, including planning, progress tracking, and final answer synthesis
  业务流程的工作原理，包括规划、进度跟踪和最终答案综合



### Define Your Agents  定义您的代理

Each agent in the Magentic pattern has a specialized role. In this example:
Magentic 模式中的每个代理都有一个专门的角色。在此示例中：

- ResearchAgent: Finds and summarizes information (e.g., via web search). Here the sample is using the `ChatCompletionAgent` with the `gpt-4o-search-preview` model for its web search capability.
  ResearchAgent：查找和总结信息（例如，通过网络搜索）。这里的示例将 `ChatCompletionAgent` 与 `gpt-4o-search-preview` 模型一起使用，以实现其 Web 搜索功能。
- CoderAgent: Writes and executes code to analyze or process data. Here the sample is using the `AzureAIAgent` since it has advanced tools like the code interpreter.
  CoderAgent：编写和执行代码来分析或处理数据。此处的示例使用 `AzureAIAgent`，因为它具有代码解释器等高级工具。

 Tip  提示

The [`ChatCompletionAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/chat-completion-agent) and [`AzureAIAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/azure-ai-agent) are used here, but you can use any [agent type](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-architecture#agent-types-in-semantic-kernel).
此处使用 [`ChatCompletionAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/chat-completion-agent) 和 [`AzureAIAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/azure-ai-agent)，但可以使用任何[代理类型 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-architecture#agent-types-in-semantic-kernel)。

C#Copy  复制

```csharp
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Agents;
using Microsoft.SemanticKernel.Agents.AzureAI;
using Microsoft.SemanticKernel.Agents.Magentic;
using Microsoft.SemanticKernel.Agents.Orchestration;
using Microsoft.SemanticKernel.Agents.Runtime.InProcess;
using Microsoft.SemanticKernel.ChatCompletion;
using Microsoft.SemanticKernel.Connectors.OpenAI;
using Azure.AI.Agents.Persistent;
using Azure.Identity;

// Helper function to create a kernel with chat completion
public static Kernel CreateKernelWithChatCompletion(...)
{
    ...
}

// Create a kernel with OpenAI chat completion for the research agent
Kernel researchKernel = CreateKernelWithChatCompletion("gpt-4o-search-preview");
ChatCompletionAgent researchAgent = new ChatCompletionAgent {
    Name = "ResearchAgent",
    Description = "A helpful assistant with access to web search. Ask it to perform web searches.",
    Instructions = "You are a Researcher. You find information without additional computation or quantitative analysis.",
    Kernel = researchKernel,
};

// Create a persistent Azure AI agent for code execution
PersistentAgentsClient agentsClient = AzureAIAgent.CreateAgentsClient(endpoint, new AzureCliCredential());
PersistentAgent definition = await agentsClient.Administration.CreateAgentAsync(
    modelId,
    name: "CoderAgent",
    description: "Write and executes code to process and analyze data.",
    instructions: "You solve questions using code. Please provide detailed analysis and computation process.",
    tools: [new CodeInterpreterToolDefinition()]);
AzureAIAgent coderAgent = new AzureAIAgent(definition, agentsClient);
```



### Set Up the Magentic Manager 设置 Magentic 管理器

The Magentic manager coordinates the agents, plans the workflow, tracks progress, and synthesizes the final answer. The standard manager (`StandardMagenticManager`) uses a chat completion model that supports structured output.
Magentic 经理协调代理、规划工作流程、跟踪进度并综合最终答案。标准管理器 （`StandardMagenticManager`） 使用支持结构化输出的聊天完成模型。

C#Copy  复制

```csharp
Kernel managerKernel = CreateKernelWithChatCompletion("o3-mini");
StandardMagenticManager manager = new StandardMagenticManager(
    managerKernel.GetRequiredService<IChatCompletionService>(),
    new OpenAIPromptExecutionSettings())
{
    MaximumInvocationCount = 5,
};
```



### Optional: Observe Agent Responses 可选：观察代理响应

You can create a callback to capture agent responses as the orchestration progresses via the `ResponseCallback` property.
可以创建回调，以便在业务流程进行时通过 `ResponseCallback` 属性捕获代理响应。

C#Copy  复制

```csharp
ChatHistory history = [];

ValueTask responseCallback(ChatMessageContent response)
{
    history.Add(response);
    return ValueTask.CompletedTask;
}
```



### Create the Magentic Orchestration 创建 Magentic 编排

Combine your agents and manager into a `MagenticOrchestration` object.
将代理和经理合并到 `MagenticOrchestration` 对象中。

C#Copy  复制

```csharp
MagenticOrchestration orchestration = new MagenticOrchestration(
    manager,
    researchAgent,
    coderAgent)
{
    ResponseCallback = responseCallback,
};
```



### Start the Runtime  启动运行时

A runtime is required to manage the execution of agents. Here, we use `InProcessRuntime` and start it before invoking the orchestration.
需要运行时来管理代理的执行。在这里，我们使用 `InProcessRuntime` 并在调用业务流程之前启动它。

C#Copy  复制

```csharp
InProcessRuntime runtime = new InProcessRuntime();
await runtime.StartAsync();
```



### Invoke the Orchestration  调用业务流程

Invoke the orchestration with your complex task. The manager will plan, delegate, and coordinate the agents to solve the problem.
使用复杂任务调用业务流程。经理将计划、委派和协调代理来解决问题。

C#Copy  复制

```csharp
string input = @"I am preparing a report on the energy efficiency of different machine learning model architectures.\nCompare the estimated training and inference energy consumption of ResNet-50, BERT-base, and GPT-2 on standard datasets (e.g., ImageNet for ResNet, GLUE for BERT, WebText for GPT-2). Then, estimate the CO2 emissions associated with each, assuming training on an Azure Standard_NC6s_v3 VM for 24 hours. Provide tables for clarity, and recommend the most energy-efficient model per task type (image classification, text classification, and text generation).";
var result = await orchestration.InvokeAsync(input, runtime);
```



### Collect Results  收集结果

Wait for the orchestration to complete and retrieve the final output.
等待业务流程完成并检索最终输出。

C#Copy  复制

```csharp
string output = await result.GetValueAsync(TimeSpan.FromSeconds(300));
Console.WriteLine($"\n# RESULT: {output}");
Console.WriteLine("\n\nORCHESTRATION HISTORY");
foreach (ChatMessageContent message in history)
{
    // Print each message
    Console.WriteLine($"# {message.Role} - {message.AuthorName}: {message.Content}");
}
```



### Optional: Stop the Runtime 可选：停止运行时

After processing is complete, stop the runtime to clean up resources.
处理完成后，停止运行时以清理资源。

C#Copy  复制

```csharp
await runtime.RunUntilIdleAsync();
```



### Sample Output  示例输出

plaintext  明文Copy  复制

```plaintext
# RESULT: ```markdown
# Report: Energy Efficiency of Machine Learning Model Architectures

This report assesses the energy consumption and related CO₂ emissions for three popular ...

ORCHESTRATION HISTORY

# Assistant - ResearchAgent: Comparing the energy efficiency of different machine learning ...

# assistant - CoderAgent: Below are tables summarizing the approximate energy consumption and ...

# assistant - CoderAgent: The estimates provided in our tables align with a general understanding ...

# assistant - CoderAgent: Here's the updated structure for the report integrating both the ...
```

 Tip  提示

The full sample code is available [here](https://github.com/microsoft/semantic-kernel/blob/main/dotnet/samples/GettingStartedWithAgents/Orchestration/Step05_Magentic.cs)
完整的示例代码可在[此处](https://github.com/microsoft/semantic-kernel/blob/main/dotnet/samples/GettingStartedWithAgents/Orchestration/Step05_Magentic.cs)获得



## Next steps  后续步骤

[  代理编排的高级主题](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-orchestration/advanced-topics)