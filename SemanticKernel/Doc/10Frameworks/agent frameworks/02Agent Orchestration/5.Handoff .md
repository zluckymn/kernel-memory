# Handoff Orchestration  切换编排

- 07/22/2025



 Important  重要

Agent Orchestration features in the Agent Framework are in the experimental stage. They are under active development and may change significantly before advancing to the preview or release candidate stage.
代理框架中的代理业务流程功能处于实验阶段。它们正在积极开发中，在进入预览版或候选版本阶段之前可能会发生重大变化。

Handoff orchestration allows agents to transfer control to one another based on the context or user request. Each agent can "handoff" the conversation to another agent with the appropriate expertise, ensuring that the right agent handles each part of the task. This is particularly useful in customer support, expert systems, or any scenario requiring dynamic delegation.
切换编排允许代理根据上下文或用户请求相互转移控制权。每个代理都可以将对话“移交”给具有适当专业知识的另一个代理，确保合适的代理处理任务的每个部分。这在客户支持、专家系统或任何需要动态委派的场景中特别有用。

To learn more about the pattern, such as when to use the pattern or when to avoid the pattern in your workload, see [Handoff orchestration](https://learn.microsoft.com/en-us/azure/architecture/ai-ml/guide/ai-agent-design-patterns#handoff-orchestration).
若要了解有关该模式的详细信息，例如何时使用该模式或何时避免工作负载中的该模式，请参阅[切换业务流程 ](https://learn.microsoft.com/en-us/azure/architecture/ai-ml/guide/ai-agent-design-patterns#handoff-orchestration)。



## Common Use Cases  常见用例

A customer support agent handles a general inquiry, then hands off to a technical expert agent for troubleshooting, or to a billing agent if needed:
客户支持代理处理一般查询，然后移交给技术专家代理进行故障排除，或根据需要移交给计费代理：

![diagram](https://learn.microsoft.com/en-us/semantic-kernel/media/multi-agent-handoff.png)



## What You'll Learn  您将学到什么

- How to define agents and their handoff relationships
  如何定义代理及其交接关系
- How to set up a handoff orchestration for dynamic agent routing
  如何为动态代理路由设置切换业务流程
- How to involve a human in the conversation loop
  如何让人类参与对话循环



### Define Specialized Agents 定义专用代理

Each agent is responsible for a specific area. In this example, we define a triage agent, a refund agent, an order status agent, and an order return agent. Some agents use plugins to handle specific tasks.
每个代理负责一个特定的领域。在此示例中，我们定义了会审代理、退款代理、订单状态代理和订单退货代理。一些代理使用插件来处理特定任务。

 Tip  提示

The [`ChatCompletionAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/chat-completion-agent) is used here, but you can use any [agent type](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-architecture#agent-types-in-semantic-kernel).
此处使用 [`ChatCompletionAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/chat-completion-agent)，但您可以使用任何[代理类型 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-architecture#agent-types-in-semantic-kernel)。

C#Copy  复制

```csharp
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Agents;
using Microsoft.SemanticKernel.Agents.Orchestration;
using Microsoft.SemanticKernel.Agents.Orchestration.Handoff;
using Microsoft.SemanticKernel.Agents.Runtime.InProcess;
using Microsoft.SemanticKernel.ChatCompletion;

// Plugin implementations
public sealed class OrderStatusPlugin {
    [KernelFunction]
    public string CheckOrderStatus(string orderId) => $"Order {orderId} is shipped and will arrive in 2-3 days.";
}
public sealed class OrderReturnPlugin {
    [KernelFunction]
    public string ProcessReturn(string orderId, string reason) => $"Return for order {orderId} has been processed successfully.";
}
public sealed class OrderRefundPlugin {
    [KernelFunction]
    public string ProcessReturn(string orderId, string reason) => $"Refund for order {orderId} has been processed successfully.";
}

// Helper function to create a kernel with chat completion
public static Kernel CreateKernelWithChatCompletion(...)
{
    ...
}

ChatCompletionAgent triageAgent = new ChatCompletionAgent {
    Name = "TriageAgent",
    Description = "Handle customer requests.",
    Instructions = "A customer support agent that triages issues.",
    Kernel = CreateKernelWithChatCompletion(...),
};

ChatCompletionAgent statusAgent = new ChatCompletionAgent {
    Name = "OrderStatusAgent",
    Description = "A customer support agent that checks order status.",
    Instructions = "Handle order status requests.",
    Kernel = CreateKernelWithChatCompletion(...),
};
statusAgent.Kernel.Plugins.Add(KernelPluginFactory.CreateFromObject(new OrderStatusPlugin()));

ChatCompletionAgent returnAgent = new ChatCompletionAgent {
    Name = "OrderReturnAgent",
    Description = "A customer support agent that handles order returns.",
    Instructions = "Handle order return requests.",
    Kernel = CreateKernelWithChatCompletion(...),
};
returnAgent.Kernel.Plugins.Add(KernelPluginFactory.CreateFromObject(new OrderReturnPlugin()));

ChatCompletionAgent refundAgent = new ChatCompletionAgent {
    Name = "OrderRefundAgent",
    Description = "A customer support agent that handles order refund.",
    Instructions = "Handle order refund requests.",
    Kernel = CreateKernelWithChatCompletion(...),
};
refundAgent.Kernel.Plugins.Add(KernelPluginFactory.CreateFromObject(new OrderRefundPlugin()));
```



### Set Up Handoff Relationships 设置切换关系

Use `OrchestrationHandoffs` to specify which agent can hand off to which, and under what circumstances.
使用 `OrchestrationHandoffs` 指定哪个代理可以切换到哪个代理，以及在什么情况下。

C#Copy  复制

```csharp
var handoffs = OrchestrationHandoffs
    .StartWith(triageAgent)
    .Add(triageAgent, statusAgent, returnAgent, refundAgent)
    .Add(statusAgent, triageAgent, "Transfer to this agent if the issue is not status related")
    .Add(returnAgent, triageAgent, "Transfer to this agent if the issue is not return related")
    .Add(refundAgent, triageAgent, "Transfer to this agent if the issue is not refund related");
```



### Observe Agent Responses  观察代理响应

You can create a callback to capture agent responses as the conversation progresses via the `ResponseCallback` property.
您可以通过 `ResponseCallback` 属性创建回调以捕获对话进行时的代理响应。

C#Copy  复制

```csharp
ChatHistory history = [];

ValueTask responseCallback(ChatMessageContent response)
{
    history.Add(response);
    return ValueTask.CompletedTask;
}
```



### Human in the Loop  人与人同在

A key feature of handoff orchestration is the ability for a human to participate in the conversation. This is achieved by providing an `InteractiveCallback`, which is called whenever an agent needs input from the user. In a real application, this would prompt the user for input; in a sample, you can use a queue of responses.
交接编排的一个关键特征是人类能够参与对话。这是通过提供 `InteractiveCallback` 来实现的，每当代理需要用户输入时都会调用该回调。在实际应用程序中，这将提示用户输入;在示例中，可以使用响应队列。

C#Copy  复制

```csharp
// Simulate user input with a queue
Queue<string> responses = new();
responses.Enqueue("I'd like to track the status of my order");
responses.Enqueue("My order ID is 123");
responses.Enqueue("I want to return another order of mine");
responses.Enqueue("Order ID 321");
responses.Enqueue("Broken item");
responses.Enqueue("No, bye");

ValueTask<ChatMessageContent> interactiveCallback()
{
    string input = responses.Dequeue();
    Console.WriteLine($"\n# INPUT: {input}\n");
    return ValueTask.FromResult(new ChatMessageContent(AuthorRole.User, input));
}
```



### Set Up the Handoff Orchestration 设置切换业务流程

Create a `HandoffOrchestration` object, passing in the agents, handoff relationships, and the callbacks.
创建一个 `HandoffOrchestration` 对象，传入代理、切换关系和回调。

C#Copy  复制

```csharp
HandoffOrchestration orchestration = new HandoffOrchestration(
    handoffs,
    triageAgent,
    statusAgent,
    returnAgent,
    refundAgent)
{
    InteractiveCallback = interactiveCallback,
    ResponseCallback = responseCallback,
};
```



### Start the Runtime  启动运行时

A runtime is required to manage the execution of agents. Here, we use `InProcessRuntime` and start it before invoking the orchestration.
需要运行时来管理代理的执行。在这里，我们使用 `InProcessRuntime` 并在调用业务流程之前启动它。

C#Copy  复制

```csharp
InProcessRuntime runtime = new InProcessRuntime();
await runtime.StartAsync();
```



### Invoke the Orchestration  调用业务流程

Invoke the orchestration with your initial task (e.g., "I am a customer that needs help with my orders"). The agents will route the conversation as needed, involving the human when required.
使用初始任务调用业务流程（例如，“我是需要订单帮助的客户”）。代理将根据需要路由对话，并在需要时让人工参与进来。

C#Copy  复制

```csharp
string task = "I am a customer that needs help with my orders";
var result = await orchestration.InvokeAsync(task, runtime);
```



### Collect Results  收集结果

Wait for the orchestration to complete and retrieve the final output.
等待业务流程完成并检索最终输出。

C#Copy  复制

```csharp
string output = await result.GetValueAsync(TimeSpan.FromSeconds(300));
Console.WriteLine($"\n# RESULT: {output}");
Console.WriteLine("\n\nORCHESTRATION HISTORY");
foreach (ChatMessageContent message in history)
{
    // Print each message
    Console.WriteLine($"# {message.Role} - {message.AuthorName}: {message.Content}");
}
```



### Optional: Stop the Runtime 可选：停止运行时

After processing is complete, stop the runtime to clean up resources.
处理完成后，停止运行时以清理资源。

C#Copy  复制

```csharp
await runtime.RunUntilIdleAsync();
```



### Sample Output  示例输出

plaintext  明文Copy  复制

```plaintext
# RESULT: Handled order return for order ID 321 due to a broken item, and successfully processed the return.

ORCHESTRATION HISTORY

# Assistant - TriageAgent: Could you please specify what kind of help you need with your orders? Are you looking to check the order status, return an item, or request a refund?

# Assistant - OrderStatusAgent: Could you please tell me your order ID?

# Assistant - OrderStatusAgent: Your order with ID 123 has been shipped and will arrive in 2-3 days. Anything else I can assist you with?

# Assistant - OrderReturnAgent: I can help you with that. Could you please provide the order ID and the reason you'd like to return it?

# Assistant - OrderReturnAgent: Please provide the reason for returning the order with ID 321.

# Assistant - OrderReturnAgent: The return for your order with ID 321 has been successfully processed due to the broken item. Anything else I can assist you with?
```

 Tip  提示

The full sample code is available [here](https://github.com/microsoft/semantic-kernel/blob/main/dotnet/samples/GettingStartedWithAgents/Orchestration/Step04_Handoff.cs)
完整的示例代码可在[此处](https://github.com/microsoft/semantic-kernel/blob/main/dotnet/samples/GettingStartedWithAgents/Orchestration/Step04_Handoff.cs)获得



## Next steps  后续步骤

[  Magentic 编排](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-orchestration/magentic)