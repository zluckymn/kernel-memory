# How-To: `OpenAIAssistantAgent` File Search 作方法：`OpenAIAssistantAgent` 文件搜索

- 05/07/2025



 Important  重要

This feature is in the release candidate stage. Features at this stage are nearly complete and generally stable, though they may undergo minor refinements or optimizations before reaching full general availability.
此功能处于候选版本阶段。此阶段的功能几乎完整且总体稳定，尽管在完全正式发布之前可能会进行一些细微的改进或优化。



## Overview  概述

In this sample, we will explore how to use the file-search tool of an [`OpenAIAssistantAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/assistant-agent) to complete comprehension tasks. The approach will be step-by-step, ensuring clarity and precision throughout the process. As part of the task, the agent will provide document citations within the response.
在此示例中，我们将探讨如何使用 [`OpenAIAssistantAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/assistant-agent) 的文件搜索工具来完成理解任务。该方法将循序渐进，确保整个过程的清晰度和精确性。作为任务的一部分，代理将在回复中提供文件引用。

Streaming will be used to deliver the agent's responses. This will provide real-time updates as the task progresses.
流式处理将用于传递代理的响应。这将随着任务的进展提供实时更新。



## Getting Started  开始

Before proceeding with feature coding, make sure your development environment is fully set up and configured.
在继续进行功能编码之前，请确保您的开发环境已完全设置和配置。

To add package dependencies from the command-line use the `dotnet` command:
若要从命令行添加包依赖项，请使用 `dotnet` 命令：

PowerShell  PowerShell 的Copy  复制

```powershell
dotnet add package Azure.Identity
dotnet add package Microsoft.Extensions.Configuration
dotnet add package Microsoft.Extensions.Configuration.Binder
dotnet add package Microsoft.Extensions.Configuration.UserSecrets
dotnet add package Microsoft.Extensions.Configuration.EnvironmentVariables
dotnet add package Microsoft.SemanticKernel
dotnet add package Microsoft.SemanticKernel.Agents.OpenAI --prerelease
```

 Important  重要

If managing NuGet packages in Visual Studio, ensure `Include prerelease` is checked.
如果在 Visual Studio 中管理 NuGet 包，请确保选中 `“包含预发行版”`。

The project file (`.csproj`) should contain the following `PackageReference` definitions:
项目文件 （`.csproj`） 应包含以下 `PackageReference` 定义：

XMLCopy  复制

```xml
  <ItemGroup>
    <PackageReference Include="Azure.Identity" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" Version="<stable>" />
    <PackageReference Include="Microsoft.SemanticKernel" Version="<latest>" />
    <PackageReference Include="Microsoft.SemanticKernel.Agents.OpenAI" Version="<latest>" />
  </ItemGroup>
```

The `Agent Framework` is experimental and requires warning suppression. This may addressed in as a property in the project file (`.csproj`):
`代理框架`是实验性的，需要警告抑制。这可以作为项目文件 （`.csproj`） 中的属性来解决：

XMLCopy  复制

```xml
  <PropertyGroup>
    <NoWarn>$(NoWarn);CA2007;IDE1006;SKEXP0001;SKEXP0110;OPENAI001</NoWarn>
  </PropertyGroup>
```

Additionally, copy the `Grimms-The-King-of-the-Golden-Mountain.txt`, `Grimms-The-Water-of-Life.txt` and `Grimms-The-White-Snake.txt` public domain content from [Semantic Kernel `LearnResources` Project](https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples/LearnResources/Resources). Add these files in your project folder and configure to have them copied to the output directory:
此外，从[Semantic Kernel `LearnResources` 项目](https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples/LearnResources/Resources)复制 `Grimms-The-King-of-the-Golden-Mountain.txt` 、`Grimms-The-Water-of-Life.txt` 和 `Grimms-The-White-Snake.txt` 公共领域内容。将这些文件添加到项目文件夹中，并配置为将它们复制到输出目录：

XMLCopy  复制

```xml
  <ItemGroup>
    <None Include="Grimms-The-King-of-the-Golden-Mountain.txt">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
    <None Include="Grimms-The-Water-of-Life.txt">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
    <None Include="Grimms-The-White-Snake.txt">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>
```



## Configuration  配置

This sample requires configuration setting in order to connect to remote services. You will need to define settings for either OpenAI or Azure OpenAI.
此示例需要配置设置才能连接到远程服务。需要为 OpenAI 或 Azure OpenAI 定义设置。

PowerShell  PowerShell 的Copy  复制

```powershell
# OpenAI
dotnet user-secrets set "OpenAISettings:ApiKey" "<api-key>"
dotnet user-secrets set "OpenAISettings:ChatModel" "gpt-4o"

# Azure OpenAI
dotnet user-secrets set "AzureOpenAISettings:ApiKey" "<api-key>" # Not required if using token-credential
dotnet user-secrets set "AzureOpenAISettings:Endpoint" "https://lightspeed-team-shared-openai-eastus.openai.azure.com/"
dotnet user-secrets set "AzureOpenAISettings:ChatModelDeployment" "gpt-4o"
```

The following class is used in all of the Agent examples. Be sure to include it in your project to ensure proper functionality. This class serves as a foundational component for the examples that follow.
以下类在所有代理示例中都使用。请务必将其包含在您的项目中，以确保功能正常。此类作为以下示例的基础组件。

c#Copy  复制

```c#
using System.Reflection;
using Microsoft.Extensions.Configuration;

namespace AgentsSample;

public class Settings
{
    private readonly IConfigurationRoot configRoot;

    private AzureOpenAISettings azureOpenAI;
    private OpenAISettings openAI;

    public AzureOpenAISettings AzureOpenAI => this.azureOpenAI ??= this.GetSettings<Settings.AzureOpenAISettings>();
    public OpenAISettings OpenAI => this.openAI ??= this.GetSettings<Settings.OpenAISettings>();

    public class OpenAISettings
    {
        public string ChatModel { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
    }

    public class AzureOpenAISettings
    {
        public string ChatModelDeployment { get; set; } = string.Empty;
        public string Endpoint { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
    }

    public TSettings GetSettings<TSettings>() =>
        this.configRoot.GetRequiredSection(typeof(TSettings).Name).Get<TSettings>()!;

    public Settings()
    {
        this.configRoot =
            new ConfigurationBuilder()
                .AddEnvironmentVariables()
                .AddUserSecrets(Assembly.GetExecutingAssembly(), optional: true)
                .Build();
    }
}
```



## Coding  编码

The coding process for this sample involves:
此示例的编码过程包括：

1. [Setup](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#setup) - Initializing settings and the plug-in.
   [设置 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#setup)- 初始化设置和插件。
2. [Agent Definition](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#agent-definition) - Create the _Chat_Completion`Agent` with templatized instructions and plug-in.
   [代理定义 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#agent-definition)- 使用模板化说明和插件创建_Chat_Completion` 代理 `。
3. [The *Chat* Loop](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#the-chat-loop) - Write the loop that drives user / agent interaction.
   [*聊天*循环 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#the-chat-loop)- 编写驱动用户/座席交互的循环。

The full example code is provided in the [Final](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#final) section. Refer to that section for the complete implementation.
最终[部分提供了](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#final)完整的示例代码。有关完整实现，请参阅该部分。



### Setup  设置

Prior to creating an `OpenAIAssistantAgent`, ensure the configuration settings are available and prepare the file resources.
在创建 `OpenAIAssistantAgent` 之前，请确保配置设置可用并准备文件资源。

Instantiate the `Settings` class referenced in the previous [Configuration](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#configuration) section. Use the settings to also create an `AzureOpenAIClient` that will be used for the [Agent Definition](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#agent-definition) as well as file-upload and the creation of a `VectorStore`.
实例化上一个[配置](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#configuration)部分中引用的 `Settings` 类。使用这些设置还可以创建 `AzureOpenAIClient，该 AzureOpenAIClient` 将用于[代理定义](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#agent-definition)以及文件上传和 `VectorStore` 的创建。

C#Copy  复制

```csharp
Settings settings = new();

AzureOpenAIClient client = OpenAIAssistantAgent.CreateAzureOpenAIClient(new AzureCliCredential(), new Uri(settings.AzureOpenAI.Endpoint));
```

Now create an empty _Vector Store for use with the *File Search* tool:
现在创建一个空的_Vector 存储以与*文件搜索*工具一起使用：

Use the `AzureOpenAIClient` to access a `VectorStoreClient` and create a `VectorStore`.
使用 `AzureOpenAIClient` 访问 `VectorStoreClient` 并创建 `VectorStore`。

C#Copy  复制

```csharp
Console.WriteLine("Creating store...");
VectorStoreClient storeClient = client.GetVectorStoreClient();
CreateVectorStoreOperation operation = await storeClient.CreateVectorStoreAsync(waitUntilCompleted: true);
string storeId = operation.VectorStoreId;
```

Let's declare the the three content-files described in the previous [Configuration](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#configuration) section:
让我们声明上一个[配置](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search?pivots=programming-language-csharp#configuration)部分中描述的三个内容文件：

C#Copy  复制

```csharp
private static readonly string[] _fileNames =
    [
        "Grimms-The-King-of-the-Golden-Mountain.txt",
        "Grimms-The-Water-of-Life.txt",
        "Grimms-The-White-Snake.txt",
    ];
```

Now upload those files and add them to the *Vector Store* by using the previously created `VectorStoreClient` clients to upload each file with a `OpenAIFileClient` and add it to the *Vector Store*, preserving the resulting *File References*.
现在，上传这些文件并将它们添加到*矢量存储*中，方法是使用之前创建的 `VectorStoreClient` 客户端上传每个文件，并使用 `OpenAIFileClient` 将其添加到*矢量存储*中，保留生成的文件*引用* 。

C#Copy  复制

```csharp
Dictionary<string, OpenAIFile> fileReferences = [];

Console.WriteLine("Uploading files...");
OpenAIFileClient fileClient = client.GetOpenAIFileClient();
foreach (string fileName in _fileNames)
{
    OpenAIFile fileInfo = await fileClient.UploadFileAsync(fileName, FileUploadPurpose.Assistants);
    await storeClient.AddFileToVectorStoreAsync(storeId, fileInfo.Id, waitUntilCompleted: true);
    fileReferences.Add(fileInfo.Id, fileInfo);
}
```



### Agent Definition  代理定义

We are now ready to instantiate an `OpenAIAssistantAgent`. The agent is configured with its target model, *Instructions*, and the *File Search* tool enabled. Additionally, we explicitly associate the *Vector Store* with the *File Search* tool.
我们现在已准备好实例化 `OpenAIAssistantAgent`。代理配置了其目标模型、 *说明*和启用*的文件搜索*工具。此外，我们还显式将*矢量存储*与*文件搜索*工具相关联。

We will utilize the `AzureOpenAIClient` again as part of creating the `OpenAIAssistantAgent`:
我们将再次使用 `AzureOpenAIClient` 作为创建 `OpenAIAssistantAgent` 的一部分：

C#Copy  复制

```csharp
Console.WriteLine("Defining assistant...");
Assistant assistant =
    await assistantClient.CreateAssistantAsync(
        settings.AzureOpenAI.ChatModelDeployment,
        name: "SampleAssistantAgent",
        instructions:
                """
                The document store contains the text of fictional stories.
                Always analyze the document store to provide an answer to the user's question.
                Never rely on your knowledge of stories not included in the document store.
                Always format response using markdown.
                """,
        enableFileSearch: true,
        vectorStoreId: storeId);

// Create agent
OpenAIAssistantAgent agent = new(assistant, assistantClient);
```



### The *Chat* Loop  *聊天*循环

At last, we are able to coordinate the interaction between the user and the `Agent`. Start by creating an `AgentThread` to maintain the conversation state and creating an empty loop.
最后，我们能够协调用户和`代理`之间的交互。首先创建一个 `AgentThread` 来维护对话状态并创建一个空循环。

Let's also ensure the resources are removed at the end of execution to minimize unnecessary charges.
我们还要确保在执行结束时删除资源，以最大程度地减少不必要的费用。

C#Copy  复制

```csharp
Console.WriteLine("Creating thread...");
OpenAIAssistantAgent agentThread = new();

Console.WriteLine("Ready!");

try
{
    bool isComplete = false;
    do
    {
        // Processing occurs here
    } while (!isComplete);
}
finally
{
    Console.WriteLine();
    Console.WriteLine("Cleaning-up...");
    await Task.WhenAll(
        [
            agentThread.DeleteAsync();
            assistantClient.DeleteAssistantAsync(assistant.Id),
            storeClient.DeleteVectorStoreAsync(storeId),
            ..fileReferences.Select(fileReference => fileClient.DeleteFileAsync(fileReference.Key))
        ]);
}
```

Now let's capture user input within the previous loop. In this case, empty input will be ignored and the term `EXIT` will signal that the conversation is completed.
现在让我们在上一个循环中捕获用户输入。在这种情况下，空输入将被忽略，术语 `EXIT` 将表示对话已完成。

C#Copy  复制

```csharp
Console.WriteLine();
Console.Write("> ");
string input = Console.ReadLine();
if (string.IsNullOrWhiteSpace(input))
{
    continue;
}
if (input.Trim().Equals("EXIT", StringComparison.OrdinalIgnoreCase))
{
    isComplete = true;
    break;
}

var message = new ChatMessageContent(AuthorRole.User, input);
Console.WriteLine();
```

Before invoking the `Agent` response, let's add a helper method to reformat the unicode annotation brackets to ANSI brackets.
在调用 `Agent` 响应之前，让我们添加一个帮助程序方法，将 Unicode 批注括号重新格式化为 ANSI 括号。

C#Copy  复制

```csharp
private static string ReplaceUnicodeBrackets(this string content) =>
    content?.Replace('【', '[').Replace('】', ']');
```

To generate an `Agent` response to user input, invoke the agent by specifying the message and agent thread. In this example, we choose a streamed response and capture any associated *Citation Annotations* for display at the end of the response cycle. Note each streamed chunk is being reformatted using the previous helper method.
要生成对用户输入的`代理`响应，请通过指定消息和代理线程来调用代理。在此示例中，我们选择流式响应并捕获任何关联的*引文注释* ，以便在响应周期结束时显示。请注意，每个流式处理块都使用前面的帮助程序方法重新格式化。

C#Copy  复制

```csharp
List<StreamingAnnotationContent> footnotes = [];
await foreach (StreamingChatMessageContent chunk in agent.InvokeStreamingAsync(message, agentThread))
{
    // Capture annotations for footnotes
    footnotes.AddRange(chunk.Items.OfType<StreamingAnnotationContent>());

    // Render chunk with replacements for unicode brackets.
    Console.Write(chunk.Content.ReplaceUnicodeBrackets());
}

Console.WriteLine();

// Render footnotes for captured annotations.
if (footnotes.Count > 0)
{
    Console.WriteLine();
    foreach (StreamingAnnotationContent footnote in footnotes)
    {
        Console.WriteLine($"#{footnote.Quote.ReplaceUnicodeBrackets()} - {fileReferences[footnote.FileId!].Filename} (Index: {footnote.StartIndex} - {footnote.EndIndex})");
    }
}
```



## Final  最后

Bringing all the steps together, we have the final code for this example. The complete implementation is provided below.
将所有步骤放在一起，我们就有了这个示例的最终代码。下面提供了完整的实现。

Try using these suggested inputs:
尝试使用以下建议的输入：

1. What is the paragraph count for each of the stories?
   每个故事的段落数是多少？
2. Create a table that identifies the protagonist and antagonist for each story.
   创建一个表格来识别每个故事的主角和反派。
3. What is the moral in The White Snake?
   《白蛇》中的寓意是什么？

C#Copy  复制

```csharp
using Azure.AI.OpenAI;
using Azure.Identity;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Agents;
using Microsoft.SemanticKernel.Agents.OpenAI;
using Microsoft.SemanticKernel.ChatCompletion;
using OpenAI.Assistants;
using OpenAI.Files;
using OpenAI.VectorStores;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AgentsSample;

public static class Program
{
    private static readonly string[] _fileNames =
        [
            "Grimms-The-King-of-the-Golden-Mountain.txt",
            "Grimms-The-Water-of-Life.txt",
            "Grimms-The-White-Snake.txt",
        ];

    /// <summary>
    /// The main entry point for the application.
    /// </summary>
    /// <returns>A <see cref="Task"/> representing the asynchronous operation.</returns>
    public static async Task Main()
    {
        // Load configuration from environment variables or user secrets.
        Settings settings = new();

        // Initialize the clients
        AzureOpenAIClient client = OpenAIAssistantAgent.CreateAzureOpenAIClient(new AzureCliCredential(), new Uri(settings.AzureOpenAI.Endpoint));
        //OpenAIClient client = OpenAIAssistantAgent.CreateOpenAIClient(new ApiKeyCredential(settings.OpenAI.ApiKey)));
        AssistantClient assistantClient = client.GetAssistantClient();
        OpenAIFileClient fileClient = client.GetOpenAIFileClient();
        VectorStoreClient storeClient = client.GetVectorStoreClient();

        // Create the vector store
        Console.WriteLine("Creating store...");
        CreateVectorStoreOperation operation = await storeClient.CreateVectorStoreAsync(waitUntilCompleted: true);
        string storeId = operation.VectorStoreId;

        // Upload files and retain file references.
        Console.WriteLine("Uploading files...");
        Dictionary<string, OpenAIFile> fileReferences = [];
        foreach (string fileName in _fileNames)
        {
            OpenAIFile fileInfo = await fileClient.UploadFileAsync(fileName, FileUploadPurpose.Assistants);
            await storeClient.AddFileToVectorStoreAsync(storeId, fileInfo.Id, waitUntilCompleted: true);
            fileReferences.Add(fileInfo.Id, fileInfo);
        }

        // Define assistant
        Console.WriteLine("Defining assistant...");
        Assistant assistant =
            await assistantClient.CreateAssistantAsync(
                settings.AzureOpenAI.ChatModelDeployment,
                name: "SampleAssistantAgent",
                instructions:
                        """
                        The document store contains the text of fictional stories.
                        Always analyze the document store to provide an answer to the user's question.
                        Never rely on your knowledge of stories not included in the document store.
                        Always format response using markdown.
                        """,
                enableFileSearch: true,
                vectorStoreId: storeId);

        // Create agent
        OpenAIAssistantAgent agent = new(assistant, assistantClient);

        // Create the conversation thread
        Console.WriteLine("Creating thread...");
        AssistantAgentThread agentThread = new();

        Console.WriteLine("Ready!");

        try
        {
            bool isComplete = false;
            do
            {
                Console.WriteLine();
                Console.Write("> ");
                string input = Console.ReadLine();
                if (string.IsNullOrWhiteSpace(input))
                {
                    continue;
                }
                if (input.Trim().Equals("EXIT", StringComparison.OrdinalIgnoreCase))
                {
                    isComplete = true;
                    break;
                }

                var message = new ChatMessageContent(AuthorRole.User, input);
                Console.WriteLine();

                List<StreamingAnnotationContent> footnotes = [];
                await foreach (StreamingChatMessageContent chunk in agent.InvokeStreamingAsync(message, agentThread))
                {
                    // Capture annotations for footnotes
                    footnotes.AddRange(chunk.Items.OfType<StreamingAnnotationContent>());

                    // Render chunk with replacements for unicode brackets.
                    Console.Write(chunk.Content.ReplaceUnicodeBrackets());
                }

                Console.WriteLine();

                // Render footnotes for captured annotations.
                if (footnotes.Count > 0)
                {
                    Console.WriteLine();
                    foreach (StreamingAnnotationContent footnote in footnotes)
                    {
                        Console.WriteLine($"#{footnote.Quote.ReplaceUnicodeBrackets()} - {fileReferences[footnote.FileId!].Filename} (Index: {footnote.StartIndex} - {footnote.EndIndex})");
                    }
                }
            } while (!isComplete);
        }
        finally
        {
            Console.WriteLine();
            Console.WriteLine("Cleaning-up...");
            await Task.WhenAll(
                [
                    agentThread.DeleteAsync(),
                    assistantClient.DeleteAssistantAsync(assistant.Id),
                    storeClient.DeleteVectorStoreAsync(storeId),
                    ..fileReferences.Select(fileReference => fileClient.DeleteFileAsync(fileReference.Key))
                ]);
        }
    }

    private static string ReplaceUnicodeBrackets(this string content) =>
        content?.Replace('【', '[').Replace('】', ']');
}
```



## Next Steps  后续步骤

[  代理编排](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-orchestration/)