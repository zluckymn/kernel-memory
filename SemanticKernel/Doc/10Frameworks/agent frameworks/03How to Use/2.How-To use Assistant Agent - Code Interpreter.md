# How-To: `OpenAIAssistantAgent` Code Interpreter 作方法：`OpenAIAssistantAgent` 代码解释器

- 05/07/2025

This feature is in the release candidate stage. Features at this stage are nearly complete and generally stable, though they may undergo minor refinements or optimizations before reaching full general availability.
此功能处于候选版本阶段。此阶段的功能几乎完整且总体稳定，尽管在完全正式发布之前可能会进行一些细微的改进或优化。



## Overview  概述

In this sample, we will explore how to use the code-interpreter tool of an [`OpenAIAssistantAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/assistant-agent) to complete data-analysis tasks. The approach will be broken down step-by-step to high-light the key parts of the coding process. As part of the task, the agent will generate both image and text responses. This will demonstrate the versatility of this tool in performing quantitative analysis.
在本示例中，我们将探讨如何使用 [`OpenAIAssistantAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/assistant-agent) 的代码解释器工具来完成数据分析任务。该方法将逐步分解，以突出编码过程的关键部分。作为任务的一部分，代理将生成图像和文本响应。这将展示该工具在执行定量分析方面的多功能性。

Streaming will be used to deliver the agent's responses. This will provide real-time updates as the task progresses.
流式处理将用于传递代理的响应。这将随着任务的进展提供实时更新。



## Getting Started  开始

Before proceeding with feature coding, make sure your development environment is fully set up and configured.
在继续进行功能编码之前，请确保您的开发环境已完全设置和配置。

Start by creating a Console project. Then, include the following package references to ensure all required dependencies are available.
首先创建一个控制台项目。然后，包含以下包引用，以确保所有必需的依赖项都可用。

To add package dependencies from the command-line use the `dotnet` command:
若要从命令行添加包依赖项，请使用 `dotnet` 命令：

PowerShell  PowerShell 的Copy  复制

```powershell
dotnet add package Azure.Identity
dotnet add package Microsoft.Extensions.Configuration
dotnet add package Microsoft.Extensions.Configuration.Binder
dotnet add package Microsoft.Extensions.Configuration.UserSecrets
dotnet add package Microsoft.Extensions.Configuration.EnvironmentVariables
dotnet add package Microsoft.SemanticKernel
dotnet add package Microsoft.SemanticKernel.Agents.OpenAI --prerelease
```

 Important  重要

If managing NuGet packages in Visual Studio, ensure `Include prerelease` is checked.
如果在 Visual Studio 中管理 NuGet 包，请确保选中 `“包含预发行版”`。

The project file (`.csproj`) should contain the following `PackageReference` definitions:
项目文件 （`.csproj`） 应包含以下 `PackageReference` 定义：

XMLCopy  复制

```xml
  <ItemGroup>
    <PackageReference Include="Azure.Identity" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" Version="<stable>" />
    <PackageReference Include="Microsoft.SemanticKernel" Version="<latest>" />
    <PackageReference Include="Microsoft.SemanticKernel.Agents.OpenAI" Version="<latest>" />
  </ItemGroup>
```

The `Agent Framework` is experimental and requires warning suppression. This may addressed in as a property in the project file (`.csproj`):
`代理框架`是实验性的，需要警告抑制。这可以作为项目文件 （`.csproj`） 中的属性来解决：

XMLCopy  复制

```xml
  <PropertyGroup>
    <NoWarn>$(NoWarn);CA2007;IDE1006;SKEXP0001;SKEXP0110;OPENAI001</NoWarn>
  </PropertyGroup>
```

Additionally, copy the `PopulationByAdmin1.csv` and `PopulationByCountry.csv` data files from [Semantic Kernel `LearnResources` Project](https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples/LearnResources/Resources). Add these files in your project folder and configure to have them copied to the output directory:
此外，从[Semantic Kernel `LearnResources` 项目](https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples/LearnResources/Resources)复制 `PopulationByAdmin1.csv` 和 `PopulationByCountry.csv` 数据文件。将这些文件添加到项目文件夹中，并配置为将它们复制到输出目录：

XMLCopy  复制

```xml
  <ItemGroup>
    <None Include="PopulationByAdmin1.csv">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
    <None Include="PopulationByCountry.csv">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>
```



## Configuration  配置

This sample requires configuration setting in order to connect to remote services. You will need to define settings for either OpenAI or Azure OpenAI.
此示例需要配置设置才能连接到远程服务。需要为 OpenAI 或 Azure OpenAI 定义设置。

PowerShell  PowerShell 的Copy  复制

```powershell
# OpenAI
dotnet user-secrets set "OpenAISettings:ApiKey" "<api-key>"
dotnet user-secrets set "OpenAISettings:ChatModel" "gpt-4o"

# Azure OpenAI
dotnet user-secrets set "AzureOpenAISettings:ApiKey" "<api-key>" # Not required if using token-credential
dotnet user-secrets set "AzureOpenAISettings:Endpoint" "<model-endpoint>"
dotnet user-secrets set "AzureOpenAISettings:ChatModelDeployment" "gpt-4o"
```

The following class is used in all of the Agent examples. Be sure to include it in your project to ensure proper functionality. This class serves as a foundational component for the examples that follow.
以下类在所有代理示例中都使用。请务必将其包含在您的项目中，以确保功能正常。此类作为以下示例的基础组件。

c#Copy  复制

```c#
using System.Reflection;
using Microsoft.Extensions.Configuration;

namespace AgentsSample;

public class Settings
{
    private readonly IConfigurationRoot configRoot;

    private AzureOpenAISettings azureOpenAI;
    private OpenAISettings openAI;

    public AzureOpenAISettings AzureOpenAI => this.azureOpenAI ??= this.GetSettings<Settings.AzureOpenAISettings>();
    public OpenAISettings OpenAI => this.openAI ??= this.GetSettings<Settings.OpenAISettings>();

    public class OpenAISettings
    {
        public string ChatModel { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
    }

    public class AzureOpenAISettings
    {
        public string ChatModelDeployment { get; set; } = string.Empty;
        public string Endpoint { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
    }

    public TSettings GetSettings<TSettings>() =>
        this.configRoot.GetRequiredSection(typeof(TSettings).Name).Get<TSettings>()!;

    public Settings()
    {
        this.configRoot =
            new ConfigurationBuilder()
                .AddEnvironmentVariables()
                .AddUserSecrets(Assembly.GetExecutingAssembly(), optional: true)
                .Build();
    }
}
```



## Coding  编码

The coding process for this sample involves:
此示例的编码过程包括：

1. [Setup](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#setup) - Initializing settings and the plug-in.
   [设置 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#setup)- 初始化设置和插件。
2. [Agent Definition](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#agent-definition) - Create the _OpenAI_Assistant`Agent` with templatized instructions and plug-in.
   [代理定义 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#agent-definition)- 使用模板化说明和插件创建_OpenAI_Assistant` 代理 `。
3. [The Chat Loop](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#the-chat-loop) - Write the loop that drives user / agent interaction.
   [聊天循环 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#the-chat-loop)- 编写驱动用户/座席交互的循环。

The full example code is provided in the [Final](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#final) section. Refer to that section for the complete implementation.
最终[部分提供了](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#final)完整的示例代码。有关完整实现，请参阅该部分。



### Setup  设置

Prior to creating an `OpenAIAssistantAgent`, ensure the configuration settings are available and prepare the file resources.
在创建 `OpenAIAssistantAgent` 之前，请确保配置设置可用并准备文件资源。

Instantiate the `Settings` class referenced in the previous [Configuration](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#configuration) section. Use the settings to also create an `AzureOpenAIClient` that will be used for the [Agent Definition](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#agent-definition) as well as file-upload.
实例化上一个[配置](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#configuration)部分中引用的 `Settings` 类。使用这些设置还可以创建将用于[代理定义](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#agent-definition)和文件上传的 `AzureOpenAIClient`。

C#Copy  复制

```csharp
Settings settings = new();

AzureOpenAIClient client = OpenAIAssistantAgent.CreateAzureOpenAIClient(new AzureCliCredential(), new Uri(settings.AzureOpenAI.Endpoint));
```

Use the `AzureOpenAIClient` to access an `OpenAIFileClient` and upload the two data-files described in the previous [Configuration](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#configuration) section, preserving the *File Reference* for final clean-up.
使用 `AzureOpenAIClient` 访问 `OpenAIFileClient` 并上传上一个[配置](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code?pivots=programming-language-csharp#configuration)部分中所述的两个数据文件，保留*文件引用*以进行最终清理。

C#Copy  复制

```csharp
Console.WriteLine("Uploading files...");
OpenAIFileClient fileClient = client.GetOpenAIFileClient();
OpenAIFile fileDataCountryDetail = await fileClient.UploadFileAsync("PopulationByAdmin1.csv", FileUploadPurpose.Assistants);
OpenAIFile fileDataCountryList = await fileClient.UploadFileAsync("PopulationByCountry.csv", FileUploadPurpose.Assistants);
```



### Agent Definition  代理定义

We are now ready to instantiate an `OpenAIAssistantAgent` by first creating an assistant definition. The assistant is configured with its target model, *Instructions*, and the *Code Interpreter* tool enabled. Additionally, we explicitly associate the two data files with the *Code Interpreter* tool.
现在，我们已准备好通过首先创建助手定义来实例化 `OpenAIAssistantAgent`。助手配置了其目标模型、 *说明*和启用*代码解释器*工具。此外，我们将这两个数据文件与*代码解释器*工具显式关联。

C#Copy  复制

```csharp
Console.WriteLine("Defining agent...");
AssistantClient assistantClient = client.GetAssistantClient();
        Assistant assistant =
            await assistantClient.CreateAssistantAsync(
                settings.AzureOpenAI.ChatModelDeployment,
                name: "SampleAssistantAgent",
                instructions:
                        """
                        Analyze the available data to provide an answer to the user's question.
                        Always format response using markdown.
                        Always include a numerical index that starts at 1 for any lists or tables.
                        Always sort lists in ascending order.
                        """,
                enableCodeInterpreter: true,
                codeInterpreterFileIds: [fileDataCountryList.Id, fileDataCountryDetail.Id]);

// Create agent
OpenAIAssistantAgent agent = new(assistant, assistantClient);
```



### The Chat Loop  聊天循环

At last, we are able to coordinate the interaction between the user and the `Agent`. Start by creating an `AgentThread` to maintain the conversation state and creating an empty loop.
最后，我们能够协调用户和`代理`之间的交互。首先创建一个 `AgentThread` 来维护对话状态并创建一个空循环。

Let's also ensure the resources are removed at the end of execution to minimize unnecessary charges.
我们还要确保在执行结束时删除资源，以最大程度地减少不必要的费用。

C#Copy  复制

```csharp
Console.WriteLine("Creating thread...");
AssistantAgentThread agentThread = new();

Console.WriteLine("Ready!");

try
{
    bool isComplete = false;
    List<string> fileIds = [];
    do
    {

    } while (!isComplete);
}
finally
{
    Console.WriteLine();
    Console.WriteLine("Cleaning-up...");
    await Task.WhenAll(
        [
            agentThread.DeleteAsync(),
            assistantClient.DeleteAssistantAsync(assistant.Id),
            fileClient.DeleteFileAsync(fileDataCountryList.Id),
            fileClient.DeleteFileAsync(fileDataCountryDetail.Id),
        ]);
}
```

Now let's capture user input within the previous loop. In this case, empty input will be ignored and the term `EXIT` will signal that the conversation is completed.
现在让我们在上一个循环中捕获用户输入。在这种情况下，空输入将被忽略，术语 `EXIT` 将表示对话已完成。

C#Copy  复制

```csharp
Console.WriteLine();
Console.Write("> ");
string input = Console.ReadLine();
if (string.IsNullOrWhiteSpace(input))
{
    continue;
}
if (input.Trim().Equals("EXIT", StringComparison.OrdinalIgnoreCase))
{
    isComplete = true;
    break;
}

var message = new ChatMessageContent(AuthorRole.User, input);

Console.WriteLine();
```

Before invoking the `Agent` response, let's add some helper methods to download any files that may be produced by the `Agent`.
在调用`代理`响应之前，让我们添加一些帮助程序方法来下载`代理`可能生成的任何文件。

Here we're place file content in the system defined temporary directory and then launching the system defined viewer application.
在这里，我们将文件内容放在系统定义的临时目录中，然后启动系统定义的查看器应用程序。

C#Copy  复制

```csharp
private static async Task DownloadResponseImageAsync(OpenAIFileClient client, ICollection<string> fileIds)
{
    if (fileIds.Count > 0)
    {
        Console.WriteLine();
        foreach (string fileId in fileIds)
        {
            await DownloadFileContentAsync(client, fileId, launchViewer: true);
        }
    }
}

private static async Task DownloadFileContentAsync(OpenAIFileClient client, string fileId, bool launchViewer = false)
{
    OpenAIFile fileInfo = client.GetFile(fileId);
    if (fileInfo.Purpose == FilePurpose.AssistantsOutput)
    {
        string filePath =
            Path.Combine(
                Path.GetTempPath(),
                Path.GetFileName(Path.ChangeExtension(fileInfo.Filename, ".png")));

        BinaryData content = await client.DownloadFileAsync(fileId);
        await using FileStream fileStream = new(filePath, FileMode.CreateNew);
        await content.ToStream().CopyToAsync(fileStream);
        Console.WriteLine($"File saved to: {filePath}.");

        if (launchViewer)
        {
            Process.Start(
                new ProcessStartInfo
                {
                    FileName = "cmd.exe",
                    Arguments = $"/C start {filePath}"
                });
        }
    }
}
```

To generate an `Agent` response to user input, invoke the agent by providing the message and the `AgentThread`. In this example, we choose a streamed response and capture any generated *File References* for download and review at the end of the response cycle. It's important to note that generated code is identified by the presence of a *Metadata* key in the response message, distinguishing it from the conversational reply.
要生成对用户输入的`代理`响应，请通过提供消息和 `AgentThread` 来调用代理。在此示例中，我们选择流式响应并捕获任何生成的文件*引用* ，以便在响应周期结束时下载和查看。请务必注意，生成的代码是通过响应消息中是否存在*元数据*键来标识的，将其与对话回复区分开来。

C#Copy  复制

```csharp
bool isCode = false;
await foreach (StreamingChatMessageContent response in agent.InvokeStreamingAsync(message, agentThread))
{
    if (isCode != (response.Metadata?.ContainsKey(OpenAIAssistantAgent.CodeInterpreterMetadataKey) ?? false))
    {
        Console.WriteLine();
        isCode = !isCode;
    }

    // Display response.
    Console.Write($"{response.Content}");

    // Capture file IDs for downloading.
    fileIds.AddRange(response.Items.OfType<StreamingFileReferenceContent>().Select(item => item.FileId));
}
Console.WriteLine();

// Download any files referenced in the response.
await DownloadResponseImageAsync(fileClient, fileIds);
fileIds.Clear();
```



## Final  最后

Bringing all the steps together, we have the final code for this example. The complete implementation is provided below.
将所有步骤放在一起，我们就有了这个示例的最终代码。下面提供了完整的实现。

Try using these suggested inputs:
尝试使用以下建议的输入：

1. Compare the files to determine the number of countries do not have a state or province defined compared to the total count
   比较文件以确定与总数相比未定义州或省的国家/地区的数量
2. Create a table for countries with state or province defined. Include the count of states or provinces and the total population
   为定义了州或省的国家/地区创建表。包括州或省的计数和总人口
3. Provide a bar chart for countries whose names start with the same letter and sort the x axis by highest count to lowest (include all countries)
   为名称以相同字母开头的国家/地区提供条形图，并按最高计数到最低计数（包括所有国家/地区）对 x 轴进行排序

C#Copy  复制

```csharp
using Azure.AI.OpenAI;
using Azure.Identity;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Agents.OpenAI;
using Microsoft.SemanticKernel.ChatCompletion;
using OpenAI.Assistants;
using OpenAI.Files;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

namespace AgentsSample;

public static class Program
{
    public static async Task Main()
    {
        // Load configuration from environment variables or user secrets.
        Settings settings = new();

        // Initialize the clients
        AzureOpenAIClient client = OpenAIAssistantAgent.CreateAzureOpenAIClient(new AzureCliCredential(), new Uri(settings.AzureOpenAI.Endpoint));
        //OpenAIClient client = OpenAIAssistantAgent.CreateOpenAIClient(new ApiKeyCredential(settings.OpenAI.ApiKey)));
        AssistantClient assistantClient = client.GetAssistantClient();
        OpenAIFileClient fileClient = client.GetOpenAIFileClient();

        // Upload files
        Console.WriteLine("Uploading files...");
        OpenAIFile fileDataCountryDetail = await fileClient.UploadFileAsync("PopulationByAdmin1.csv", FileUploadPurpose.Assistants);
        OpenAIFile fileDataCountryList = await fileClient.UploadFileAsync("PopulationByCountry.csv", FileUploadPurpose.Assistants);

        // Define assistant
        Console.WriteLine("Defining assistant...");
        Assistant assistant =
            await assistantClient.CreateAssistantAsync(
                settings.AzureOpenAI.ChatModelDeployment,
                name: "SampleAssistantAgent",
                instructions:
                        """
                        Analyze the available data to provide an answer to the user's question.
                        Always format response using markdown.
                        Always include a numerical index that starts at 1 for any lists or tables.
                        Always sort lists in ascending order.
                        """,
                enableCodeInterpreter: true,
                codeInterpreterFileIds: [fileDataCountryList.Id, fileDataCountryDetail.Id]);

        // Create agent
        OpenAIAssistantAgent agent = new(assistant, assistantClient);

        // Create the conversation thread
        Console.WriteLine("Creating thread...");
        AssistantAgentThread agentThread = new();

        Console.WriteLine("Ready!");

        try
        {
            bool isComplete = false;
            List<string> fileIds = [];
            do
            {
                Console.WriteLine();
                Console.Write("> ");
                string input = Console.ReadLine();
                if (string.IsNullOrWhiteSpace(input))
                {
                    continue;
                }
                if (input.Trim().Equals("EXIT", StringComparison.OrdinalIgnoreCase))
                {
                    isComplete = true;
                    break;
                }

                var message = new ChatMessageContent(AuthorRole.User, input);

                Console.WriteLine();

                bool isCode = false;
                await foreach (StreamingChatMessageContent response in agent.InvokeStreamingAsync(message, agentThread))
                {
                    if (isCode != (response.Metadata?.ContainsKey(OpenAIAssistantAgent.CodeInterpreterMetadataKey) ?? false))
                    {
                        Console.WriteLine();
                        isCode = !isCode;
                    }

                    // Display response.
                    Console.Write($"{response.Content}");

                    // Capture file IDs for downloading.
                    fileIds.AddRange(response.Items.OfType<StreamingFileReferenceContent>().Select(item => item.FileId));
                }
                Console.WriteLine();

                // Download any files referenced in the response.
                await DownloadResponseImageAsync(fileClient, fileIds);
                fileIds.Clear();

            } while (!isComplete);
        }
        finally
        {
            Console.WriteLine();
            Console.WriteLine("Cleaning-up...");
            await Task.WhenAll(
                [
                    agentThread.DeleteAsync(),
                    assistantClient.DeleteAssistantAsync(assistant.Id),
                    fileClient.DeleteFileAsync(fileDataCountryList.Id),
                    fileClient.DeleteFileAsync(fileDataCountryDetail.Id),
                ]);
        }
    }

    private static async Task DownloadResponseImageAsync(OpenAIFileClient client, ICollection<string> fileIds)
    {
        if (fileIds.Count > 0)
        {
            Console.WriteLine();
            foreach (string fileId in fileIds)
            {
                await DownloadFileContentAsync(client, fileId, launchViewer: true);
            }
        }
    }

    private static async Task DownloadFileContentAsync(OpenAIFileClient client, string fileId, bool launchViewer = false)
    {
        OpenAIFile fileInfo = client.GetFile(fileId);
        if (fileInfo.Purpose == FilePurpose.AssistantsOutput)
        {
            string filePath =
                Path.Combine(
                    Path.GetTempPath(),
                    Path.GetFileName(Path.ChangeExtension(fileInfo.Filename, ".png")));

            BinaryData content = await client.DownloadFileAsync(fileId);
            await using FileStream fileStream = new(filePath, FileMode.CreateNew);
            await content.ToStream().CopyToAsync(fileStream);
            Console.WriteLine($"File saved to: {filePath}.");

            if (launchViewer)
            {
                Process.Start(
                    new ProcessStartInfo
                    {
                        FileName = "cmd.exe",
                        Arguments = $"/C start {filePath}"
                    });
            }
        }
    }
}
```



## Next steps  后续步骤

[  作方法：`OpenAIAssistantAgent` 代码文件搜索](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-search)