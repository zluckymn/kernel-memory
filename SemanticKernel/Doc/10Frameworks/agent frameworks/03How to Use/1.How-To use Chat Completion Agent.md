# How-To: `ChatCompletionAgent` 作方法：`ChatCompletionAgent`

- 05/07/2025



## Overview  概述

In this sample, we will explore configuring a plugin to access GitHub API and provide templatized instructions to a [`ChatCompletionAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/chat-completion-agent) to answer questions about a GitHub repository. The approach will be broken down step-by-step to high-light the key parts of the coding process. As part of the task, the agent will provide document citations within the response.
在此示例中，我们将探索配置插件以访问 GitHub API，并向 [`ChatCompletionAgent`](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/agent-types/chat-completion-agent) 提供模板化说明以回答有关 GitHub 存储库的问题。该方法将逐步分解，以突出编码过程的关键部分。作为任务的一部分，代理将在回复中提供文件引用。

Streaming will be used to deliver the agent's responses. This will provide real-time updates as the task progresses.
流式处理将用于传递代理的响应。这将随着任务的进展提供实时更新。



## Getting Started  开始

Before proceeding with feature coding, make sure your development environment is fully set up and configured.
在继续进行功能编码之前，请确保您的开发环境已完全设置和配置。

Start by creating a *Console* project. Then, include the following package references to ensure all required dependencies are available.
首先创建一个*控制台*项目。然后，包含以下包引用，以确保所有必需的依赖项都可用。

To add package dependencies from the command-line use the `dotnet` command:
若要从命令行添加包依赖项，请使用 `dotnet` 命令：

PowerShell  PowerShell 的Copy  复制

```powershell
dotnet add package Azure.Identity
dotnet add package Microsoft.Extensions.Configuration
dotnet add package Microsoft.Extensions.Configuration.Binder
dotnet add package Microsoft.Extensions.Configuration.UserSecrets
dotnet add package Microsoft.Extensions.Configuration.EnvironmentVariables
dotnet add package Microsoft.SemanticKernel.Connectors.AzureOpenAI
dotnet add package Microsoft.SemanticKernel.Agents.Core --prerelease
```

 Important  重要

If managing NuGet packages in Visual Studio, ensure `Include prerelease` is checked.
如果在 Visual Studio 中管理 NuGet 包，请确保选中 `“包含预发行版”`。

The project file (`.csproj`) should contain the following `PackageReference` definitions:
项目文件 （`.csproj`） 应包含以下 `PackageReference` 定义：

XMLCopy  复制

```xml
  <ItemGroup>
    <PackageReference Include="Azure.Identity" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" Version="<stable>" />
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" Version="<stable>" />
    <PackageReference Include="Microsoft.SemanticKernel.Agents.Core" Version="<latest>" />
    <PackageReference Include="Microsoft.SemanticKernel.Connectors.AzureOpenAI" Version="<latest>" />
  </ItemGroup>
```

The `Agent Framework` is experimental and requires warning suppression. This may addressed in as a property in the project file (`.csproj`):
`代理框架`是实验性的，需要警告抑制。这可以作为项目文件 （`.csproj`） 中的属性来解决：

XMLCopy  复制

```xml
  <PropertyGroup>
    <NoWarn>$(NoWarn);CA2007;IDE1006;SKEXP0001;SKEXP0110;OPENAI001</NoWarn>
  </PropertyGroup>
```

Additionally, copy the GitHub plug-in and models (`GitHubPlugin.cs` and `GitHubModels.cs`) from [Semantic Kernel `LearnResources` Project](https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples/LearnResources/Plugins/GitHub). Add these files in your project folder.
此外，从 [Semantic Kernel `LearnResources` Project](https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples/LearnResources/Plugins/GitHub) 复制 GitHub 插件和模型（`GitHubPlugin.cs` 和 `GitHubModels.cs`）。将这些文件添加到项目文件夹中。



## Configuration  配置

This sample requires configuration setting in order to connect to remote services. You will need to define settings for either OpenAI or Azure OpenAI and also for GitHub.
此示例需要配置设置才能连接到远程服务。需要为 OpenAI 或 Azure OpenAI 以及 GitHub 定义设置。

 Note  注意

For information on GitHub Personal Access Tokens, see: [Managing your personal access tokens](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens).
有关 GitHub 个人访问令牌的信息，请参阅：[ 管理个人访问令牌 ](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)。

PowerShell  PowerShell 的Copy  复制

```powershell
# OpenAI
dotnet user-secrets set "OpenAISettings:ApiKey" "<api-key>"
dotnet user-secrets set "OpenAISettings:ChatModel" "gpt-4o"

# Azure OpenAI
dotnet user-secrets set "AzureOpenAISettings:ApiKey" "<api-key>" # Not required if using token-credential
dotnet user-secrets set "AzureOpenAISettings:Endpoint" "<model-endpoint>"
dotnet user-secrets set "AzureOpenAISettings:ChatModelDeployment" "gpt-4o"

# GitHub
dotnet user-secrets set "GitHubSettings:BaseUrl" "https://api.github.com"
dotnet user-secrets set "GitHubSettings:Token" "<personal access token>"
```

The following class is used in all of the Agent examples. Be sure to include it in your project to ensure proper functionality. This class serves as a foundational component for the examples that follow.
以下类在所有代理示例中都使用。请务必将其包含在您的项目中，以确保功能正常。此类作为以下示例的基础组件。

c#Copy  复制

```c#
using System.Reflection;
using Microsoft.Extensions.Configuration;

namespace AgentsSample;

public class Settings
{
    private readonly IConfigurationRoot configRoot;

    private AzureOpenAISettings azureOpenAI;
    private OpenAISettings openAI;

    public AzureOpenAISettings AzureOpenAI => this.azureOpenAI ??= this.GetSettings<Settings.AzureOpenAISettings>();
    public OpenAISettings OpenAI => this.openAI ??= this.GetSettings<Settings.OpenAISettings>();

    public class OpenAISettings
    {
        public string ChatModel { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
    }

    public class AzureOpenAISettings
    {
        public string ChatModelDeployment { get; set; } = string.Empty;
        public string Endpoint { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
    }

    public TSettings GetSettings<TSettings>() =>
        this.configRoot.GetRequiredSection(typeof(TSettings).Name).Get<TSettings>()!;

    public Settings()
    {
        this.configRoot =
            new ConfigurationBuilder()
                .AddEnvironmentVariables()
                .AddUserSecrets(Assembly.GetExecutingAssembly(), optional: true)
                .Build();
    }
}
```



## Coding  编码

The coding process for this sample involves:
此示例的编码过程包括：

1. [Setup](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#setup) - Initializing settings and the plug-in.
   [设置 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#setup)- 初始化设置和插件。
2. [`Agent` Definition](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#agent-definition) - Create the `ChatCompletionAgent` with templatized instructions and plug-in.
   [`代理`定义 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#agent-definition)- 使用模板化指令和插件创建 `ChatCompletionAgent`。
3. [The Chat Loop](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#the-chat-loop) - Write the loop that drives user / agent interaction.
   [聊天循环 ](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#the-chat-loop)- 编写驱动用户/座席交互的循环。

The full example code is provided in the [Final](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#final) section. Refer to that section for the complete implementation.
最终[部分提供了](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#final)完整的示例代码。有关完整实现，请参阅该部分。



### Setup  设置

Prior to creating a `ChatCompletionAgent`, the configuration settings, plugins, and `Kernel` must be initialized.
在创建 `ChatCompletionAgent` 之前，必须初始化配置设置、插件和`内核 `。

Initialize the `Settings` class referenced in the previous [Configuration](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#configuration) section.
初始化上一个[配置](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-chat-agent?pivots=programming-language-csharp#configuration)部分中引用的 `Settings` 类。

C#Copy  复制

```csharp
Settings settings = new();
```

Initialize the plug-in using its settings.
使用插件的设置初始化插件。

Here, a message is displaying to indicate progress.
在这里，显示一条消息以指示进度。

C#Copy  复制

```csharp
Console.WriteLine("Initialize plugins...");
GitHubSettings githubSettings = settings.GetSettings<GitHubSettings>();
GitHubPlugin githubPlugin = new(githubSettings);
```

Now initialize a `Kernel` instance with an `IChatCompletionService` and the `GitHubPlugin` previously created.
现在，使用 `IChatCompletionService` 和之前创建的 `GitHubPlugin` 初始化内`核`实例。

C#Copy  复制

```csharp
Console.WriteLine("Creating kernel...");
IKernelBuilder builder = Kernel.CreateBuilder();

builder.AddAzureOpenAIChatCompletion(
    settings.AzureOpenAI.ChatModelDeployment,
    settings.AzureOpenAI.Endpoint,
    new AzureCliCredential());

builder.Plugins.AddFromObject(githubPlugin);

Kernel kernel = builder.Build();
```



### Agent Definition  代理定义

Finally we are ready to instantiate a `ChatCompletionAgent` with its Instructions, associated `Kernel`, and the default Arguments and Execution Settings. In this case, we desire to have the any plugin functions automatically executed.
最后，我们准备好实例化一个 `ChatCompletionAgent`，其中包含其指令、关联`的内核`以及默认的参数和执行设置。在这种情况下，我们希望自动执行任何插件函数。

C#Copy  复制

```csharp
Console.WriteLine("Defining agent...");
ChatCompletionAgent agent =
    new()
    {
        Name = "SampleAssistantAgent",
        Instructions =
            """
            You are an agent designed to query and retrieve information from a single GitHub repository in a read-only manner.
            You are also able to access the profile of the active user.

            Use the current date and time to provide up-to-date details or time-sensitive responses.

            The repository you are querying is a public repository with the following name: {{$repository}}

            The current date and time is: {{$now}}. 
            """,
        Kernel = kernel,
        Arguments =
            new KernelArguments(new AzureOpenAIPromptExecutionSettings() { FunctionChoiceBehavior = FunctionChoiceBehavior.Auto() })
            {
                { "repository", "microsoft/semantic-kernel" }
            }
    };

Console.WriteLine("Ready!");
```



### The Chat Loop  聊天循环

At last, we are able to coordinate the interaction between the user and the `Agent`. Start by creating a `ChatHistoryAgentThread` object to maintain the conversation state and creating an empty loop.
最后，我们能够协调用户和`代理`之间的交互。首先创建一个 `ChatHistoryAgentThread` 对象来维护对话状态并创建一个空循环。

C#Copy  复制

```csharp
ChatHistoryAgentThread agentThread = new();
bool isComplete = false;
do
{
    // processing logic here
} while (!isComplete);
```

Now let's capture user input within the previous loop. In this case, empty input will be ignored and the term `EXIT` will signal that the conversation is completed.
现在让我们在上一个循环中捕获用户输入。在这种情况下，空输入将被忽略，术语 `EXIT` 将表示对话已完成。

C#Copy  复制

```csharp
Console.WriteLine();
Console.Write("> ");
string input = Console.ReadLine();
if (string.IsNullOrWhiteSpace(input))
{
    continue;
}
if (input.Trim().Equals("EXIT", StringComparison.OrdinalIgnoreCase))
{
    isComplete = true;
    break;
}

var message = new ChatMessageContent(AuthorRole.User, input);

Console.WriteLine();
```

To generate a `Agent` response to user input, invoke the agent using *Arguments* to provide the final template parameter that specifies the current date and time.
要生成对用户输入的`代理`响应，请使用 *Arguments* 调用代理，以提供指定当前日期和时间的最终模板参数。

The `Agent` response is then then displayed to the user.
然后，` 代理`响应将显示给用户。

C#Copy  复制

```csharp
DateTime now = DateTime.Now;
KernelArguments arguments =
    new()
    {
        { "now", $"{now.ToShortDateString()} {now.ToShortTimeString()}" }
    };
await foreach (ChatMessageContent response in agent.InvokeAsync(message, agentThread, options: new() { KernelArguments = arguments }))
{
    Console.WriteLine($"{response.Content}");
}
```



## Final  最后

Bringing all the steps together, we have the final code for this example. The complete implementation is provided below.
将所有步骤放在一起，我们就有了这个示例的最终代码。下面提供了完整的实现。

Try using these suggested inputs:
尝试使用以下建议的输入：

1. What is my username?
   我的用户名是什么？
2. Describe the repo.  描述存储库。
3. Describe the newest issue created in the repo.
   描述存储库中创建的最新问题。
4. List the top 10 issues closed within the last week.
   列出上周关闭的前 10 个问题。
5. How were these issues labeled?
   这些问题是如何被标记的？
6. List the 5 most recently opened issues with the "Agents" label
   列出最近打开的 5 个带有“代理”标签的问题

C#Copy  复制

```csharp
using System;
using System.Threading.Tasks;
using Azure.Identity;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Agents;
using Microsoft.SemanticKernel.ChatCompletion;
using Microsoft.SemanticKernel.Connectors.AzureOpenAI;
using Plugins;

namespace AgentsSample;

public static class Program
{
    public static async Task Main()
    {
        // Load configuration from environment variables or user secrets.
        Settings settings = new();

        Console.WriteLine("Initialize plugins...");
        GitHubSettings githubSettings = settings.GetSettings<GitHubSettings>();
        GitHubPlugin githubPlugin = new(githubSettings);

        Console.WriteLine("Creating kernel...");
        IKernelBuilder builder = Kernel.CreateBuilder();

        builder.AddAzureOpenAIChatCompletion(
            settings.AzureOpenAI.ChatModelDeployment,
            settings.AzureOpenAI.Endpoint,
            new AzureCliCredential());

        builder.Plugins.AddFromObject(githubPlugin);

        Kernel kernel = builder.Build();

        Console.WriteLine("Defining agent...");
        ChatCompletionAgent agent =
            new()
            {
                Name = "SampleAssistantAgent",
                Instructions =
                        """
                        You are an agent designed to query and retrieve information from a single GitHub repository in a read-only manner.
                        You are also able to access the profile of the active user.

                        Use the current date and time to provide up-to-date details or time-sensitive responses.

                        The repository you are querying is a public repository with the following name: {{$repository}}

                        The current date and time is: {{$now}}. 
                        """,
                Kernel = kernel,
                Arguments =
                    new KernelArguments(new AzureOpenAIPromptExecutionSettings() { FunctionChoiceBehavior = FunctionChoiceBehavior.Auto() })
                    {
                        { "repository", "microsoft/semantic-kernel" }
                    }
            };

        Console.WriteLine("Ready!");

        ChatHistoryAgentThread agentThread = new();
        bool isComplete = false;
        do
        {
            Console.WriteLine();
            Console.Write("> ");
            string input = Console.ReadLine();
            if (string.IsNullOrWhiteSpace(input))
            {
                continue;
            }
            if (input.Trim().Equals("EXIT", StringComparison.OrdinalIgnoreCase))
            {
                isComplete = true;
                break;
            }

            var message = new ChatMessageContent(AuthorRole.User, input);

            Console.WriteLine();

            DateTime now = DateTime.Now;
            KernelArguments arguments =
                new()
                {
                    { "now", $"{now.ToShortDateString()} {now.ToShortTimeString()}" }
                };
            await foreach (ChatMessageContent response in agent.InvokeAsync(message, agentThread, options: new() { KernelArguments = arguments }))
            {
                // Display response.
                Console.WriteLine($"{response.Content}");
            }

        } while (!isComplete);
    }
}
```



## Next Steps  后续步骤

[  作方法：`OpenAIAssistantAgent` 代码解释器](https://learn.microsoft.com/en-us/semantic-kernel/frameworks/agent/examples/example-assistant-code)