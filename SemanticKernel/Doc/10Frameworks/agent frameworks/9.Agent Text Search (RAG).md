# Adding Retrieval Augmented Generation (RAG) to Semantic Kernel Agents 将检索增强生成 （RAG） 添加到Semantic Kernel代理

- 07/01/2025



 Warning  警告

The Semantic Kernel Agent RAG functionality is experimental, subject to change, and will only be finalized based on feedback and evaluation.
Semantic Kernel代理 RAG 功能是实验性的，可能会发生变化，并且只会根据反馈和评估最终确定。



## Using the TextSearchProvider for RAG 使用 RAG 的 TextSearchProvider

The `Microsoft.SemanticKernel.Data.TextSearchProvider` allows agents to retrieve relevant documents based on user input and inject them into the agent's context for more informed responses. It integrates an `Microsoft.SemanticKernel.Data.ITextSearch` instance with Semantic Kernel agents. Multiple `ITextSearch` implementations exist, supporting similarity searches on vector stores and search engine integration. More information can be found [here](https://learn.microsoft.com/en-us/semantic-kernel/concepts/text-search/).
它 `Microsoft.SemanticKernel.Data.TextSearchProvider` 允许代理根据用户输入检索相关文档，并将其注入代理的上下文中，以获得更明智的响应。它将实例 `Microsoft.SemanticKernel.Data.ITextSearch` 与Semantic Kernel代理集成在一起。存在多个 `ITextSearch` 实现，支持对向量存储和搜索引擎集成进行相似性搜索。更多信息[可以在这里找到 ](https://learn.microsoft.com/en-us/semantic-kernel/concepts/text-search/)。

We also provide a `Microsoft.SemanticKernel.Data.TextSearchStore`, which provides simple, opinionated vector storage of textual data for the purposes of Retrieval Augmented Generation. `TextSearchStore` has a built-in schema for storing and retrieving textual data in a vector store. If you wish to use your own schema for storage, check out [VectorStoreTextSearch](https://learn.microsoft.com/en-us/semantic-kernel/concepts/text-search/text-search-vector-stores).
我们还提供了一个 `Microsoft.SemanticKernel.Data.TextSearchStore` ，它为检索增强生成的目的提供了简单、固执己见的文本数据矢量存储。 `TextSearchStore` 有一个内置的架构，用于在向量存储中存储和检索文本数据。如果您希望使用自己的模式进行存储，请查看 [VectorStoreTextSearch](https://learn.microsoft.com/en-us/semantic-kernel/concepts/text-search/text-search-vector-stores)。



## Setting Up the TextSearchProvider 设置 TextSearchProvider

The `TextSearchProvider` can be used with a `VectorStore` and `TextSearchStore` to store and search text documents.
`TextSearchProvider` 可以与 `VectorStore` 和 `TextSearchStore` 一起使用，以存储和搜索文本文档。

The following example demonstrates how to set up and use the `TextSearchProvider` with a `TextSearchStore` and `InMemoryVectorStore` for an agent to perform simple RAG over text.
以下示例演示了如何设置和使用 `TextSearchProvider 以及 TextSearchStore` 和 `InMemoryVectorStore`，以便代理``对文本执行简单的 RAG。

C#Copy  复制

```csharp
// Create an embedding generator using Azure OpenAI.
var embeddingGenerator = new AzureOpenAIClient(new Uri("<Your_Azure_OpenAI_Endpoint>"), new AzureCliCredential())
    .GetEmbeddingClient("<Your_Deployment_Name>")
    .AsIEmbeddingGenerator(1536);

// Create a vector store to store documents.
var vectorStore = new InMemoryVectorStore(new() { EmbeddingGenerator = embeddingGenerator });

// Create a TextSearchStore for storing and searching text documents.
using var textSearchStore = new TextSearchStore<string>(vectorStore, collectionName: "FinancialData", vectorDimensions: 1536);

// Upsert documents into the store.
await textSearchStore.UpsertTextAsync(new[]
{
    "The financial results of Contoso Corp for 2024 is as follows:\nIncome EUR 154 000 000\nExpenses EUR 142 000 000",
    "The Contoso Corporation is a multinational business with its headquarters in Paris."
});

// Create an agent.
Kernel kernel = new Kernel();
ChatCompletionAgent agent = new()
{
    Name = "FriendlyAssistant",
    Instructions = "You are a friendly assistant",
    Kernel = kernel,
    // This setting must be set to true when using the on-demand RAG feature
    UseImmutableKernel = true
};

// Create an agent thread and add the TextSearchProvider.
ChatHistoryAgentThread agentThread = new();
var textSearchProvider = new TextSearchProvider(textSearchStore);
agentThread.AIContextProviders.Add(textSearchProvider);

// Use the agent with RAG capabilities.
ChatMessageContent response = await agent.InvokeAsync("Where is Contoso based?", agentThread).FirstAsync();
Console.WriteLine(response.Content);
```



## Advanced Features: Citations and Filtering 高级功能：引文和过滤

The `TextSearchStore` supports advanced features such as filtering results by namespace and including citations in responses.
`TextSearchStore` 支持高级功能，例如按命名空间过滤结果以及在响应中包含引用。



### Including Citations  包括引文

Documents in the `TextSearchStore` can include metadata like source names and links, enabling citation generation in agent responses.
`TextSearchStore` 中的文档可以包含源名称和链接等元数据，从而在代理响应中生成引文。

C#Copy  复制

```csharp
await textSearchStore.UpsertDocumentsAsync(new[]
{
    new TextSearchDocument
    {
        Text = "The financial results of Contoso Corp for 2023 is as follows:\nIncome EUR 174 000 000\nExpenses EUR 152 000 000",
        SourceName = "Contoso 2023 Financial Report",
        SourceLink = "https://www.contoso.com/reports/2023.pdf",
        Namespaces = ["group/g2"]
    }
});
```

When the `TextSearchProvider` retrieves this document, it will by default include the source name and link in its response.
当 `TextSearchProvider` 检索此文档时，默认情况下，它将在其响应中包含源名称和链接。



### Filtering by Namespace  按命名空间过滤

When upserting documents you can optionally provide one or more namespaces for each document. Namespaces can be any string that defines the scope of a document. You can then configure the `TextSearchStore` to limit search results to only those records that match the requested namespace.
更新插入文档时，您可以选择为每个文档提供一个或多个命名空间。命名空间可以是定义文档范围的任何字符串。然后，您可以配置 `TextSearchStore`，将搜索结果限制为仅与请求的命名空间匹配的记录。

C#Copy  复制

```csharp
using var textSearchStore = new TextSearchStore<string>(
    vectorStore,
    collectionName: "FinancialData",
    vectorDimensions: 1536,
    new() { SearchNamespace = "group/g2" }
);
```



### Automatic vs on-demand RAG 自动与按需 RAG

The `TextSearchProvider` can perform searches automatically during each agent invocation or allow on-demand searches via tool calls when the agent needs additional information.
`TextSearchProvider` 可以在每次代理调用期间自动执行搜索，或者在代理需要其他信息时允许通过工具调用进行按需搜索。

The default setting is `BeforeAIInvoke`, which means that searches will be performed before each agent invocation using the message passed to the agent. This can be changed to `OnDemandFunctionCalling`, which will allow the Agent to make a tool call to do searches using a search string of the agent's choice.
默认设置为 `BeforeAIInvoke`，这意味着将在每次代理调用之前使用传递给代理的消息执行搜索。这可以更改为 `OnDemandFunctionCalling`，这将允许代理进行工具调用，以使用代理选择的搜索字符串进行搜索。

C#Copy  复制

```csharp
var options = new TextSearchProviderOptions
{
    SearchTime = TextSearchProviderOptions.RagBehavior.OnDemandFunctionCalling,
};

var provider = new TextSearchProvider(mockTextSearch.Object, options: options);
```

 Warning  警告

When using the `TextSearchProvider` with `OnDemandFunctionCalling`, the `UseImmutableKernel` setting on the agent has to be set to `true` as the feature requires cloning the kernel when invoking the agent. Note that setting `UseImmutableKernel` to `true` will mean that any kernel data modifications done during the agent invocation by e.g. plugins, will not be retained after the invocation completes.
将 `TextSearchProvider` 与 `OnDemandFunctionCalling` 一起使用时，代理上的 `UseImmutableKernel` 设置必须设置为 `true`，因为该功能在调用代理时需要克隆内核。请注意，将 `UseImmutableKernel` 设置为 `true` 将意味着在调用完成后，将不会保留在代理调用期间通过插件等方式进行的任何内核数据修改。



## TextSearchProvider options TextSearchProvider 选项

The `TextSearchProvider` can be configured with various options to customize its behavior. Options are provided using the `TextSearchProviderOptions` class to the `TextSearchProvider` constructor.
`TextSearchProvider` 可以使用各种选项进行配置，以自定义其行为。使用 `TextSearchProviderOptions` 类向 `TextSearchProvider` 构造函数提供选项。



### Top  返回页首

Specifies the maximum number of results to return from the similarity search.
指定从相似性搜索返回的最大结果数。

- **Default**: 3  **默认值** ：3



### SearchTime  搜索时间

Controls when the text search is performed. Options include:
控制何时执行文本搜索。选项包括：

- **BeforeAIInvoke**: A search is performed each time the model/agent is invoked, just before invocation, and the results are provided to the model/agent via the invocation context.
  **BeforeAIInvoke**：每次调用模型/代理时，在调用之前执行搜索，并通过调用上下文将结果提供给模型/代理。
- **OnDemandFunctionCalling**: A search may be performed by the model/agent on demand via function calling.
  **OnDemandFunctionCalling**：模型/代理可以按需通过函数调用执行搜索。



### PluginFunctionName  插件函数名称

Specifies the name of the plugin method that will be made available for searching if `SearchTime` is set to `OnDemandFunctionCalling`.
指定在 `SearchTime` 设置为 `OnDemandFunctionCalling` 时可用于搜索的插件方法的名称。

- **Default**: "Search"
  **默认值** ：“搜索”



### PluginFunctionDescription 插件功能描述

Provides a description of the plugin method that will be made available for searching if `SearchTime` is set to `OnDemandFunctionCalling`.
提供插件方法的说明，如果 `SearchTime` 设置为 `OnDemandFunctionCalling`，则该方法将可用于搜索。

- **Default**: "Allows searching for additional information to help answer the user question."
  **默认值** ：“允许搜索其他信息以帮助回答用户问题。



### ContextPrompt  上下文提示

When providing the text chunks to the AI model on invocation, a prompt is required to indicate to the AI model what the text chunks are for and how they should be used. This setting allows overriding the default messaging that is built into the `TextSearchProvider`.
在调用时向 AI 模型提供文本块时，需要提示以向 AI 模型指示文本块的用途以及如何使用它们。此设置允许重写`内置于 TextSearchProvider` 中的默认消息传递。



### IncludeCitationsPrompt

When providing the text chunks to the AI model on invocation, a prompt is required to tell to the AI model whether and how to do citations. This setting allows overriding the default messaging that is built into the `TextSearchProvider`.
在调用时向 AI 模型提供文本块时，需要提示来告诉 AI 模型是否以及如何进行引用。此设置允许重写`内置于 TextSearchProvider` 中的默认消息传递。



### ContextFormatter  上下文格式化程序

This optional callback can be used to completely customize the text that is produced by the `TextSearchProvider`. By default the `TextSearchProvider` will produce text that includes
此可选回调可用于完全自定义 `TextSearchProvider` 生成的文本。默认情况下，`TextSearchProvider` 将生成包含

1. A prompt telling the AI model what the text chunks are for.
   告诉 AI 模型文本块的用途的提示。
2. The list of text chunks with source links and names.
   具有源链接和名称的文本块列表。
3. A prompt instructing the AI model about including citations.
   指示 AI 模型包含引文的提示。

You can write your own output by implementing and providing this callback.
您可以通过实现和提供此回调来编写自己的输出。

**Note**: If this delegate is provided, the `ContextPrompt` and `IncludeCitationsPrompt` settings will not be used.
**注意** ：如果提供了此委托，则不会使用 `ContextPrompt` 和 `IncludeCitationsPrompt` 设置。



## Combining RAG with Other Providers 将 RAG 与其他提供商相结合

The `TextSearchProvider` can be combined with other providers, such as `mem0` or `WhiteboardProvider`, to create agents with both memory and retrieval capabilities.
`TextSearchProvider` 可以与其他提供程序（例如 `mem0` 或 `WhiteboardProvider`）结合使用，以创建具有内存和检索功能的代理。

C#Copy  复制

```csharp
// Add both mem0 and TextSearchProvider to the agent thread.
agentThread.AIContextProviders.Add(mem0Provider);
agentThread.AIContextProviders.Add(textSearchProvider);

// Use the agent with combined capabilities.
ChatMessageContent response = await agent.InvokeAsync("What was Contoso's income for 2023?", agentThread).FirstAsync();
Console.WriteLine(response.Content);
```

By combining these features, agents can deliver a more personalized and context-aware experience.
通过结合这些功能，代理可以提供更加个性化和上下文感知的体验。